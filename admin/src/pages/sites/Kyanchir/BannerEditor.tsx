// ============================================================================
// src/pages/sites/Kyanchir/BannerEditor.tsx - –†–ï–î–ê–ö–¢–û–†–°–ö–ò–ô –ü–£–õ–¨–¢ –î–õ–Ø –ë–ê–ù–ù–ï–†–ê
// ============================================================================
// –≠—Ç–æ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ –æ–¥–Ω—É –∑–∞–¥–∞—á—É:
// —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–Ω–Ω–µ—Ä–∞ –Ω–∞ —Å–∞–π—Ç–µ. –û–Ω –æ–±–ª–∞–¥–∞–µ—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π –ª–æ–≥–∏–∫–æ–π,
// –≤–∫–ª—é—á–∞—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –∏ —Ä—É—á–Ω—É—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é.
// ============================================================================

// --- 1. –ò–ú–ü–û–†–¢–´ ---
import React, { useEffect, useState } from "react";
import axios from "axios"; // –ò—Å–ø–æ–ª—å–∑—É–µ–º axios –¥–ª—è –±–æ–ª–µ–µ —É–¥–æ–±–Ω—ã—Ö API-–∑–∞–ø—Ä–æ—Å–æ–≤.

// --- 2. –ß–ï–†–¢–ï–ñ–ò –ò –ö–û–ù–°–¢–ê–ù–¢–´ ---
type Banner = {
  title: string;
  subtitle: string;
  imageUrl: string;
};

// ‚ùóÔ∏è –ñ–µ—Å—Ç–∫–æ "–∑–∞—à–∏—Ç—ã–π" ID —Å–∞–π—Ç–∞. –í –±—É–¥—É—â–µ–º —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å
//    –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∏–∑–≤–Ω–µ (—á–µ—Ä–µ–∑ –ø—Ä–æ–ø—Å—ã), —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å—Ç–∞–ª –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º.
const siteId = "kyanchir";

// ============================================================================
// --- –ö–û–ú–ü–û–ù–ï–ù–¢ BannerEditor ---
// ============================================================================
export const BannerEditor: React.FC = () => {
  // --- 3. –°–û–°–¢–û–Ø–ù–ò–ï –ö–û–ú–ü–û–ù–ï–ù–¢–ê ("–Ø–ß–ï–ô–ö–ò –ü–ê–ú–Ø–¢–ò") ---

  // –Ø—á–µ–π–∫–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞, —Å –∫–æ—Ç–æ—Ä—ã–º —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
  const [draft, setDraft] = useState<Banner>({
    title: "",
    subtitle: "",
    imageUrl: "",
  });
  // –Ø—á–µ–π–∫–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ (–¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏).
  const [published, setPublished] = useState<Banner | null>(null);
  // –Ø—á–µ–π–∫–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.
  const [saving, setSaving] = useState<"idle" | "saving" | "saved" | "error">(
    "idle"
  );

  // --- 4. –õ–û–ì–ò–ö–ê ---

  // "–î–∞—Ç—á–∏–∫", –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç
  // —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ —á–µ—Ä–Ω–æ–≤–∏–∫, –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –±–∞–Ω–Ω–µ—Ä–∞.
  useEffect(() => {
    const fetchBannerData = async () => {
      // ‚ùóÔ∏è –í –±—É–¥—É—â–µ–º —ç—Ç–∏ –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π API-–∫–ª–∏–µ–Ω—Ç.
      // ‚ùóÔ∏è –ó–¥–µ—Å—å —Ç–∞–∫–∂–µ –Ω—É–∂–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫, –∫–∞–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ SitesPage.
      const draftRes = await axios.get(
        `/api/sites/${siteId}/banner?preview=true`
      );
      const pubRes = await axios.get(
        `/api/sites/${siteId}/banner?preview=false`
      );
      setDraft(draftRes.data);
      setPublished(pubRes.data);
    };
    fetchBannerData();
  }, []); // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ `[]` = "—Å—Ä–∞–±–æ—Ç–∞–π –æ–¥–∏–Ω —Ä–∞–∑".

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞.
  const handleChange = (key: keyof Banner, value: string) => {
    // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫ –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏...
    setDraft((prev) => ({ ...prev, [key]: value }));
    // ... –∏ —Å—Ä–∞–∑—É –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è", —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ—Å–µ–π–≤.
    setSaving("saving");
  };

  // "–£–º–Ω—ã–π —Ç–∞–π–º–µ—Ä" –¥–ª—è –ê–í–¢–û–°–û–•–†–ê–ù–ï–ù–ò–Ø (Debounce).
  // –≠—Ç–æ—Ç "–¥–∞—Ç—á–∏–∫" —Å–ª–µ–¥–∏—Ç –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ `draft` –∏ `saving`.
  useEffect(() => {
    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ "—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è", –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º.
    if (saving !== "saving") return;

    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä. –ï—Å–ª–∏ –∑–∞ 1.2 —Å–µ–∫—É–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∏—á–µ–≥–æ –±–æ–ª—å—à–µ
    // –Ω–µ –∏–∑–º–µ–Ω–∏—Ç, –∫–æ–¥ –≤–Ω—É—Ç—Ä–∏ —Ç–∞–π–º–µ—Ä–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏—Ç -
    // —ç—Ç–æ—Ç —Ç–∞–π–º–µ—Ä –æ—á–∏—Å—Ç–∏—Ç—Å—è, –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–æ–≤—ã–π.
    const timeout = setTimeout(() => {
      const saveDraft = async () => {
        try {
          // ‚ùóÔ∏è –û–ø—è—Ç—å –∂–µ, –≤ –±—É–¥—É—â–µ–º —ç—Ç–æ –±—É–¥–µ—Ç –≤—ã–∑–æ–≤ `api.saveBannerDraft(draft)`.
          await axios.put(`/api/admin/sites/${siteId}/draft/banner`, draft);
          setSaving("saved"); // –°—Ç–∞—Ç—É—Å: "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"
        } catch (err) {
          console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", err);
          setSaving("error"); // –°—Ç–∞—Ç—É—Å: "–û—à–∏–±–∫–∞!"
        }
      };
      saveDraft();
    }, 1200); // –ó–∞–¥–µ—Ä–∂–∫–∞ –≤ 1.2 —Å–µ–∫—É–Ω–¥—ã.

    // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏: –æ–Ω–∞ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è
    // –∏–ª–∏ –µ—Å–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è (—Ç.–µ. –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç –ø–µ—á–∞—Ç–∞—Ç—å).
    return () => clearTimeout(timeout);
  }, [draft, saving]); // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.
  const publish = async () => {
    try {
      // ‚ùóÔ∏è –í—ã–∑–æ–≤ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏.
      await axios.post(`/api/admin/sites/${siteId}/publish/banner`);
      // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ,
      // –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏.
      setPublished(draft);
      alert("–ë–∞–Ω–Ω–µ—Ä –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!");
    } catch (e) {
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏");
    }
  };

  // --- 5. –û–¢–†–ò–°–û–í–ö–ê (JSX) ---
  return (
    <div className="p-4 space-y-3">
      <div className="text-sm text-gray-500">
        {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è */}
        –ß–µ—Ä–Ω–æ–≤–∏–∫ –±–∞–Ω–Ω–µ—Ä–∞ (–∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, —Å—Ç–∞—Ç—É—Å: <b>{saving}</b>)
      </div>

      {/* –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */}
      <input
        className="w-full border p-2 rounded"
        placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫"
        value={draft.title}
        onChange={(e) => handleChange("title", e.target.value)}
      />
      <input
        className="w-full border p-2 rounded"
        placeholder="–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫"
        value={draft.subtitle}
        onChange={(e) => handleChange("subtitle", e.target.value)}
      />
      <input
        className="w-full border p-2 rounded"
        placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏"
        value={draft.imageUrl}
        onChange={(e) => handleChange("imageUrl", e.target.value)}
      />

      {/* –ö–Ω–æ–ø–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ */}
      <button
        className="px-4 py-2 bg-black text-white rounded"
        onClick={publish}
      >
        üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
      </button>

      {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ —Å –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π */}
      {published && (
        <div className="text-xs text-gray-500 mt-4">
          <b>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ:</b> {published.title} / {published.subtitle}
        </div>
      )}
    </div>
  );
};
