// ============================================================================
// routes/sites.ts - "–î–ò–°–ü–ï–¢–ß–ï–†–°–ö–ê–Ø –í–´–®–ö–ê" (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–∞–π—Ç–∞–º–∏)
// ============================================================================
// –≠—Ç–æ—Ç —Ñ–∞–π–ª - –∫–ª—é—á–µ–≤–æ–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º —Å–∞–π—Ç–æ–≤. –û–Ω –≥—Ä–∞–º–æ—Ç–Ω–æ
// —Ä–∞–∑–¥–µ–ª–µ–Ω –Ω–∞ –¥–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö "–ø—É–ª—å—Ç–∞" (—Ä–æ—É—Ç–µ—Ä–∞):
// 1. `publicSitesRouter`: –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ—Ç –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞).
// 2. `adminSitesRouter`: –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ—Ç –Ω–∞—à–µ–π –∞–¥–º–∏–Ω–∫–∏).
// ============================================================================

import { Router } from "express";
import { readFileSync, writeFileSync, promises as fs } from "fs";
import { resolve, join } from "path";
import { ensureSuperAdmin } from "../middlewares/authMiddleware"; // –ù–∞—à "–æ—Ö—Ä–∞–Ω–Ω–∏–∫" –¥–ª—è superadmin.

// --- 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –î–í–£–• –†–û–£–¢–ï–†–û–í ---
export const publicSitesRouter = Router();
export const adminSitesRouter = Router();

// ‚ùóÔ∏è –í—Å—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–æ–º `sites.json` –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.
const sitesFilePath = resolve(__dirname, "../db/sites.json");

// ============================================================================
// --- –ß–ê–°–¢–¨ 1: –ü–£–ë–õ–ò–ß–ù–´–ï –ú–ê–†–®–†–£–¢–´ (–¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Å–∞–π—Ç–æ–≤) ---
// ============================================================================
// –≠—Ç–∏ –º–∞—Ä—à—Ä—É—Ç—ã –Ω–µ —Ç—Ä–µ–±—É—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –û–Ω–∏ –æ—Ç–¥–∞—é—Ç —Ç–æ–ª—å–∫–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

// GET /api/sites/:id/banner - –û—Ç–¥–∞–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–π –±–∞–Ω–Ω–µ—Ä (–∏–ª–∏ —á–µ—Ä–Ω–æ–≤–∏–∫, –µ—Å–ª–∏ –µ—Å—Ç—å `?preview=true`).
publicSitesRouter.get("/:id/banner", (req, res) => {
  const siteId = req.params.id;
  const isPreview = req.query.preview === "true"; // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞.

  try {
    const sites = JSON.parse(readFileSync(sitesFilePath, "utf-8"));
    const site = sites.find((s: any) => s.id === siteId);
    if (!site) return res.status(404).json({ error: "–°–∞–π—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω" });

    // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–ª–∞–≥–∞, –æ—Ç–¥–∞–µ–º –ª–∏–±–æ —á–µ—Ä–Ω–æ–≤–∏–∫, –ª–∏–±–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é.
    const banner = isPreview ? site.banner?.draft : site.banner?.published;
    if (!banner) return res.status(404).json({ error: "–ë–∞–Ω–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω" });

    res.json(banner);
  } catch (e) {
    res.status(500).json({ error: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–∞–Ω–Ω–µ—Ä" });
  }
});

// ============================================================================
// --- –ß–ê–°–¢–¨ 2: –ê–î–ú–ò–ù–°–ö–ò–ï –ú–ê–†–®–†–£–¢–´ (–¥–ª—è –Ω–∞—à–µ–π –∞–¥–º–∏–Ω–∫–∏) ---
// ============================================================================
// üîê –í—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã –Ω–∏–∂–µ –∑–∞—â–∏—â–µ–Ω—ã `requireAuth` (–≤ `index.ts`)
//    –∏ `ensureSuperAdmin` (–ø—Ä—è–º–æ –∑–¥–µ—Å—å).

// GET /api/admin/sites/ - –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –í–°–ï–• —Å–∞–π—Ç–æ–≤ —Å–æ –í–°–ï–ú–ò –¥–∞–Ω–Ω—ã–º–∏.
adminSitesRouter.get("/", ensureSuperAdmin, (req, res) => {
  // ... (–ª–æ–≥–∏–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ sites.json) ...
});

// PUT /api/admin/sites/:id/status - –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–∞–π—Ç–∞ (active/disabled).
adminSitesRouter.put("/:id/status", ensureSuperAdmin, (req, res) => {
  // ... (–ª–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –ø–æ–∏—Å–∫–∞, –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è) ...
});

// --- –ú–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–Ω–Ω–µ—Ä–æ–º ---

// PUT /api/admin/sites/:id/draft/banner - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫ –±–∞–Ω–Ω–µ—Ä–∞.
adminSitesRouter.put("/:id/draft/banner", ensureSuperAdmin, (req, res) => {
  // ... (–ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞) ...
});

// POST /api/admin/sites/:id/publish/banner - –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –±–∞–Ω–Ω–µ—Ä.
adminSitesRouter.post("/:id/publish/banner", ensureSuperAdmin, (req, res) => {
  // –õ–æ–≥–∏–∫–∞ –∑–¥–µ—Å—å –æ—á–µ–Ω—å –≥—Ä–∞–º–æ—Ç–Ω–∞—è:
  // 1. –ù–∞—Ö–æ–¥–∏–º —Å–∞–π—Ç.
  // 2. –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ `site.banner.draft`.
  // 3. –ö–æ–ø–∏—Ä—É–µ–º –∏—Ö –≤ `site.banner.published`.
  // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Å—å —Ñ–∞–π–ª.
  // ... (–æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞) ...
});

// --- –ú–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞–º–∏ ---
// ‚ùóÔ∏è –≠—Ç–æ—Ç –º–∞—Ä—à—Ä—É—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π –ø–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–º—É –ø—É—Ç–∏.
//    –≠—Ç–æ –º–æ—â–Ω–æ, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –æ—Å–æ–±–æ–π –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
adminSitesRouter.get(
  "/:siteId/draft/products",
  ensureSuperAdmin,
  async (req, res) => {
    const { siteId } = req.params;
    try {
      // –í –±—É–¥—É—â–µ–º `siteId` –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç "—Å–∞–Ω–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å" (–æ—á–∏—â–∞—Ç—å),
      // —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∞—Ç–∞–∫–∏ —Ç–∏–ø–∞ "path traversal" (../../...).
      const filePath = join(__dirname, `../db/${siteId}/products.json`);
      const raw = await fs.readFile(filePath, "utf-8");
      res.json(JSON.parse(raw));
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:", err);
      res.status(500).json({ error: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤" });
    }
  }
);

// ‚ùóÔ∏è –ó–¥–µ—Å—å –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤ –¥–ª—è –°–û–•–†–ê–ù–ï–ù–ò–Ø –ø—Ä–æ–¥—É–∫—Ç–æ–≤.
//    –ù—É–∂–µ–Ω `PUT /:siteId/draft/products`.
